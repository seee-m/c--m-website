<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio</title>
    <!-- Mobile browser chrome color -->
    <meta name="theme-color" content="#000108">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Background and work images -->
        <img id="background" class="background" alt="Background">
        <img id="work" class="work" alt="Work">
        
        <!-- Header with title and navigation -->
        <header class="header">
            <div class="title-box">
                <p class="title">[C--M] Connor MacDonald, Applied Artist & Designer</p>
            </div>

            <div class="readout-box">
                <p class="readout" id="fileReadout"></p>
            </div>

            <nav class="nav-box">
                <button onclick="window.location.href='pages/links/links.html'" class="nav-link">[more]</button>
                <button id="reroll" class="nav-link">[reroll]</button>
            </nav>
           
        </header>
    </div>

    <script>
        // Configuration
        const IMAGE_PATH = '/media/background/';
        const WORK_PATH = '/media/work/';
        const TYPING_SPEED = 50; // milliseconds per character
        
        // State
        let backgrounds = [];
        let works = [];
        let currentWorkFile = '';
        let typewriterTimeout;
        
        // Utility
        const random = (array) => array[Math.floor(Math.random() * array.length)];
        
        // Get thumbnail path from full path
        function getThumbPath(fullPath) {
            const parts = fullPath.split('/');
            const filename = parts.pop();
            const baseName = filename.replace(/\.[^/.]+$/, '');
            parts.push('thumbs', `${baseName}.jpg`);
            return parts.join('/');
        }
        
        // Progressive image loader
        function loadProgressively(imgElement, fullSrc) {
            const thumbSrc = getThumbPath(fullSrc);
            const startTime = Date.now();
            
            // Load thumbnail immediately with pixelated rendering
            imgElement.src = thumbSrc;
            imgElement.style.imageRendering = 'pixelated';
            imgElement.style.imageRendering = '-moz-crisp-edges';
            imgElement.style.imageRendering = 'crisp-edges';
            
            // Preload full image
            const fullImg = new Image();
            fullImg.onload = () => {
                const elapsed = Date.now() - startTime;
                const delay = Math.max(0, 500 - elapsed); // Ensure 0.5s minimum display
                
                setTimeout(() => {
                    imgElement.src = fullSrc;
                    imgElement.style.imageRendering = 'auto';
                }, delay);
            };
            fullImg.src = fullSrc;
        }
        
        // Load image list from text file
        async function loadImages(filename, path) {
            try {
                const response = await fetch(filename);
                const text = await response.text();
                return text
                    .split('\n')
                    .filter(line => line.trim())
                    .map(img => path + img);
            } catch (error) {
                console.error(`Failed to load ${filename}:`, error);
                return [];
            }
        }
        
        // Typewriter effect
        function typeWriter(text, element) {
            // Clear any existing timeout
            if (typewriterTimeout) {
                clearTimeout(typewriterTimeout);
            }
            
            element.textContent = '';
            let index = 0;
            
            function type() {
                if (index < text.length) {
                    element.textContent += text.charAt(index);
                    index++;
                    typewriterTimeout = setTimeout(type, TYPING_SPEED);
                }
            }
            
            type();
        }
        
        // Update displayed images
        function refresh() {
            if (backgrounds.length) {
                const bgPath = random(backgrounds);
                loadProgressively(document.getElementById('background'), bgPath);
            }
            if (works.length) {
                const workPath = random(works);
                // Load work images directly without thumbnail
                document.getElementById('work').src = workPath;
                
                // Extract filename from path and update readout
                currentWorkFile = workPath.replace(WORK_PATH, '');
                const readoutElement = document.getElementById('fileReadout');
                typeWriter(currentWorkFile, readoutElement);
            }
        }
        
        // Initialize
        async function init() {
            backgrounds = await loadImages('/media/background/background.txt', IMAGE_PATH);
            works = await loadImages('/media/work/work.txt', WORK_PATH);
            refresh();
        }
        
        // Events
        document.getElementById('reroll').addEventListener('click', refresh);
        
        // Position work image below nav-box on mobile
        function positionWorkImage() {
            if (window.innerWidth <= 600) {
                const navBox = document.querySelector('.nav-box');
                const workImg = document.getElementById('work');
                
                if (navBox && workImg) {
                    const navBoxRect = navBox.getBoundingClientRect();
                    const navBoxBottom = navBoxRect.bottom;
                    
                    // Position work image so its top aligns with nav-box bottom
                    workImg.style.top = navBoxBottom + 'px';
                    workImg.style.bottom = 'auto';
                }
            } else {
                // Reset for desktop
                const workImg = document.getElementById('work');
                workImg.style.top = '';
                workImg.style.bottom = '';
            }
        }
        
        // Run on load and resize
        window.addEventListener('load', positionWorkImage);
        window.addEventListener('resize', positionWorkImage);
        
        // Update refresh to reposition after image changes
        const originalRefresh = refresh;
        refresh = function() {
            originalRefresh();
            setTimeout(positionWorkImage, 100);
        };
        
        // Start
        init();
    </script>
</body>
</html>